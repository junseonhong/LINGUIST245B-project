<!DOCTYPE html>
<html>
<head>
  <title>Question Experiment</title>
  <!-- Load JsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <script src="stims.js"></script>
  
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  
</head>
<body>
  <script>
    // Initialize jsPsych
    const jsPsych = initJsPsych({
     show_progress_bar: true,
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });

    //Store each trial in a list called timeline 
    const timeline = [];

    // Instructions
    const instructions = {
      type: jsPsychInstructions,
      pages: [`
        <div class="content"><h2>Welcome, and thank you for participating!</h2> <br>
        <p>In this experiment, you will be presented with short everyday situations, each described in two parts.</p>
        <div style="border: 1px solid #ccc; padding: 15px; background-color: #f9f9f9; border-radius: 8px; margin: 15px 0;">
            <li><strong>Part 1:</strong> You'll read what someone told you earlier, along with a picture.</li>
            <li><strong>Part 2:</strong> You'll see what actually happens in that situation, again with a picture.</li>
        </div>        
        <p>After reading both parts, you'll see a list of questions. Please select the one you would most naturally ask in that context.</p>
        <p>Then, you will record yourself asking the selected question aloud using your microphone. Please try to speak clearly and naturally.</p>
        <p><strong>Make sure you are in a quiet space, and your microphone is working properly.</strong></p>
        <p>Click "Next" to set up your microphone and begin the experiment.</p></div>
        `
    ],
    show_clickable_nav: true,
    };      
    timeline.push(instructions);

    // Setting up microphone
    const trial = {
      type: jsPsychInitializeMicrophone,
      device_select_message: [`
            <p>Before starting the experiment, we need to ensure your microphone is set up correctly.</p>
            <p>When prompted by your browser, please <strong>allow microphone access</strong>.</p>
            <p><p>Once access is granted, you'll see a list of available microphones. <strong>Select the one you plan to use</strong>.</p>
            `
            ]
    };
    timeline.push(trial);
    
    // Microphone test trial
    const trialinstructions = {
      type: jsPsychInstructions,
      pages: [`
            <div class="content"><h2>Microphone Test</h2>
            <p>Next, you'll test your microphone by making a short recording.</p>
            <p>When you're ready, click "Next" to begin.</p>
            <p>Speak naturally â€” you can say something like: <em>"Testing, 1, 2, 3."</em></p>
            <p>You'll be able to play back your recording to confirm that it worked.</p>
            `
    ],
    show_clickable_nav: true,
    };      
    timeline.push(trialinstructions);

    const testing = {
    type: jsPsychHtmlAudioResponse,
    stimulus: `
        <h2 style="color: red;">Recording in Progress...</h2>
        <p>Please say something like: <em>"Testing 1 2 3"</em></p>
        `,
    show_done_button: true,
    done_button_label: 'Finish Recording',
    recording_duration: 5000,
    allow_playback: true,
    };
    timeline.push(testing)

    const begin = {
      type: jsPsychInstructions,
      pages: ['<div class="content"><h1>Let\'s begin!</h1>'],
      show_clickable_nav: true,
    };      
    timeline.push(begin);

    // Generate Trials
    const shuffledStimuliSets = jsPsych.randomization.shuffle(stimuliSets);
    shuffledStimuliSets.forEach(set => {
      for (let t = 0; t < 1; t++) {
        // Get allowed combinations: exclude pos-pos and neg-neg
        const allowedPairs = set.originalBiasOptions.flatMap(orig =>
          set.contextualEvidenceOptions
            .filter(evi => {
              const origVal = orig.condition.split('-')[1];
              const eviVal = evi.condition.split('-')[1];
              return !(origVal === "pos" && eviVal === "pos") &&
                     !(origVal === "neg" && eviVal === "neg");
            })
            .map(evi => ({ original: orig, context: evi }))
    );

    const selectedPair = jsPsych.randomization.sampleWithoutReplacement(allowedPairs, 1)[0];
    const randomOriginal = selectedPair.original;
    const randomContext = selectedPair.context;

    const choiceinstructions = {
      type: jsPsychInstructions,
      pages: [
        `
          <p>${set.description1}</p>
          <img src="${randomOriginal.image}" style="max-width:100px;"><br>
          <p>${randomOriginal.caption}</p>
        `,
        `
          <p>${set.description2}</p>
          <img src="${randomContext.image}" style="max-width:100px;"><br>
          <p>${randomContext.caption}</p>
        `
      ],
      show_clickable_nav: true,
      button_label_previous: "Back",
      button_label_next: "Next"
    };
    timeline.push(choiceinstructions);

    // List of Polar Questions
    const questionchoice = {
      type: jsPsychSurveyMultiChoice,
      preamble: `
        <div style="border: 1px solid #ccc; background-color: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
          <p><strong>Reminder of what you just saw</strong></p>
          <p>${set.description1}</p>
          <p><em>${randomOriginal.caption}</em></p>
          <p>${set.description2}</p>
          <p><em>${randomContext.caption}</em></p>
        </div>
        <p><strong>Select ONE question from the list below that you would ask.</strong></p>
        <p>After making your choice, click "Continue" to proceed.</p>
      `,
      questions: [
        {
          prompt: "Which question would you ask?",
          options: set.polarQuestions.map(q => q.question),
          required: true
        }
      ],
      button_label: "Continue",
      data: {
        category: set.category,
        phase: 'polar_question',
        caption1_condition: randomOriginal.condition,
        caption2_condition: randomContext.condition
      },
      on_finish: function(data) {
        const selected = data.response.Q0;
        const questionObj = set.polarQuestions.find(q => q.question === selected);
        data.selected_question = selected;
        data.selected_question_type = questionObj ? questionObj.type : "Unknown";
      }
    };
    timeline.push(questionchoice);
    // For "other" option:
    timeline.push({
      timeline: [
        {
          type: jsPsychSurveyText,
          questions: [
            {
              prompt: "You selected 'Other'. Please type the question you would ask:",
              name: 'other_question',
              placeholder: 'Type your question here:',
              required: true
            }
          ],
          button_label: "Continue",
          on_finish: function(data) {
            const custom = data.response.other_question;
            data.selected_question = custom;
            data.selected_question_type = "Other";
            // Update previous polar question trial as well
            const last = jsPsych.data.get().filter({ phase: 'polar_question' }).last(1);
            last.addToLast({ selected_question: custom, selected_question_type: "Other" });
          }
        }
      ],
      conditional_function: function() {
        const last = jsPsych.data.get().filter({ phase: 'polar_question' }).last(1).values()[0];
        return last && last.response && last.response.Q0 === "Other";
      }
    });

    //Recording
    const recordinginstructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>Recording</h2>
        <p>You will now record your question.</p>
        <p>When you're ready, click the button below to start recording.</p>
        <p>The recording will start automatically, and you have up to 10 seconds.</p>
      `,
      choices: ['Start Recording']
    };
    timeline.push(recordinginstructions);

    const recordQuestion = {
      type: jsPsychHtmlAudioResponse,
      stimulus: function() {
        const selected = jsPsych.data.get().filter({phase: 'polar_question'}).last(1).values()[0].response.Q0;
        return `
          <h2 style="color: red; font-weight: bold;">Recording in progress...</h2>
          <p><strong>You selected:</strong> "${selected}"</p>
        `;
      },
      show_done_button: true,
      done_button_label: 'Finish Recording',
      recording_duration: 10000
    };
    timeline.push(recordQuestion);
    }
    });


      // save data
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;

    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "4Lxq8NvoSbCB",
      filename: filename,
      data_string: () => {
        const responses = jsPsych.data.get().filter({ phase: 'polar_question' }).values();
        const audioResponses = jsPsych.data.get().filter({ type: 'html-audio-response' }).values();

        const combinedData = responses.map((trial, index) => {
        const audioData = audioResponses[index] ? audioResponses[index].response : null;
          return {
            category: trial.category,
            caption1_condition: trial.caption1_condition,
            caption2_condition: trial.caption2_condition,
            selected_question: trial.selected_question,
            selected_question_type: trial.selected_question_type,
            audio_data: audioData // Include the audio data
          };
        });

        const csvRows = [
          ['category', 'caption1_condition', 'caption2_condition', 'selected_question', 'selected_question_type', 'audio_data'],
          ...combinedData.map(row => [
            row.category,
            row.caption1_condition,
            row.caption2_condition,
            `"${row.selected_question}"`,
            row.selected_question_type,
            row.audio_data // Save the audio data (will likely be a Blob object or its string representation)
          ])
        ];

        return csvRows.map(e => e.join(",")).join("\n");
      },
      on_finish: function(data) {
        console.log("Data and audio saved!");
      }
    };
    timeline.push(save_data);
    

    const completion = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div class="content"><h2>Thank you!</h2>' +
                '<p>The experiment is now complete.</p>',
      choices: [' ']
    };
    timeline.push(completion);

    // This line actually runs the experiment 
    jsPsych.run(timeline);
  </script>
</body>
</html>